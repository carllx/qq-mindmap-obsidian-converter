# ç¯å¢ƒé›†æˆæŒ‡å¯¼

## ğŸ¯ Tampermonkey ç”¨æˆ·è„šæœ¬ç‰¹æ€§

### CDN ä¾èµ–ç®¡ç†
- **å¤–éƒ¨ä¾èµ–**ï¼šé€šè¿‡ `@require` åŠ è½½ CDN èµ„æº
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šæŒ‡å®šä¾èµ–çš„ç²¾ç¡®ç‰ˆæœ¬
- **åŠ è½½é¡ºåº**ï¼šç¡®ä¿ä¾èµ–æŒ‰æ­£ç¡®é¡ºåºåŠ è½½
- **é”™è¯¯å¤„ç†**ï¼šå¤„ç†ä¾èµ–åŠ è½½å¤±è´¥çš„æƒ…å†µ

### æµè§ˆå™¨ç¯å¢ƒé€‚é…
```javascript
// ç”¨æˆ·è„šæœ¬å¤´éƒ¨é…ç½®
// ==UserScript==
// @name         QQ Mind Map to Obsidian Converter
// @namespace    http://tampermonkey.net/
// @version      2.0.0
// @description  Converts QQ Mind Map to Obsidian Markdown and vice-versa
// @author       carllx & Gemini
// @match        https://docs.qq.com/mind/*
// @grant        GM_setClipboard
// @grant        GM_addStyle
// @grant        GM_setValue
// @grant        GM_getValue
// @require      https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js
// @require      https://cdn.jsdelivr.net/npm/dompurify@3.1.5/dist/purify.min.js
// ==/UserScript==
```

## ğŸ”§ æ¨¡å—ç³»ç»Ÿ

### ç®€åŒ–çš„æ¨¡å—å®šä¹‰
```javascript
// ç«‹å³åˆ›å»ºå…¨å±€å¯¹è±¡
window.QQMindMap2Obsidian = {
    test: true,
    version: 'simple',
    status: 'initializing'
};

// ç®€åŒ–çš„æ¨¡å—ç³»ç»Ÿ
const modules = {};
function define(name, factory) { 
    try {
        modules[name] = factory();
        console.log('âœ… Module loaded:', name);
    } catch (error) {
        console.error('âŒ Error loading module:', name, error);
    }
}
function require(name) { 
    const module = modules[name];
    if (!module) {
        console.error('âŒ Module not found:', name);
    }
    return module;
}
```

### æ¨¡å—åŠ è½½ç­–ç•¥
- **å»¶è¿ŸåŠ è½½**ï¼šæŒ‰éœ€åŠ è½½æ¨¡å—
- **é”™è¯¯æ¢å¤**ï¼šå¤„ç†æ¨¡å—åŠ è½½å¤±è´¥
- **ä¾èµ–è§£æ**ï¼šè‡ªåŠ¨è§£ææ¨¡å—ä¾èµ–
- **ç¼“å­˜æœºåˆ¶**ï¼šé¿å…é‡å¤åŠ è½½

## ğŸ¨ UI ç»„ä»¶å¼€å‘

### ç”¨æˆ·ç•Œé¢åŸåˆ™
- **éä¾µå…¥æ€§**ï¼šä¸å¹²æ‰°åŸæœ‰é¡µé¢åŠŸèƒ½
- **å“åº”å¼è®¾è®¡**ï¼šé€‚åº”ä¸åŒå±å¹•å°ºå¯¸
- **ç”¨æˆ·å‹å¥½**ï¼šæä¾›æ¸…æ™°çš„äº¤äº’åé¦ˆ
- **å¯è®¿é—®æ€§**ï¼šæ”¯æŒé”®ç›˜å¯¼èˆªå’Œå±å¹•é˜…è¯»å™¨

### UI ç»„ä»¶ç¤ºä¾‹
```javascript
// åˆ›å»ºç”¨æˆ·ç•Œé¢
function createUI(parentElement) {
    const container = document.createElement('div');
    container.className = 'qq-converter-ui';
    container.innerHTML = `
        <div class="converter-header">
            <h3>QQ Mind Map Converter</h3>
        </div>
        <div class="converter-controls">
            <button id="qq-to-md" class="btn btn-primary">QQ â†’ MD</button>
            <button id="md-to-qq" class="btn btn-secondary">MD â†’ QQ</button>
        </div>
        <div class="converter-status" id="status"></div>
    `;
    
    parentElement.appendChild(container);
    return container;
}
```

### æ ·å¼ç®¡ç†
```javascript
// æ·»åŠ æ ·å¼
function addStyles() {
    const style = document.createElement('style');
    style.textContent = `
        .qq-converter-ui {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 4px;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
    `;
    document.head.appendChild(style);
}
```

## ğŸ“‹ é€šçŸ¥ç³»ç»Ÿ

### ç”¨æˆ·åé¦ˆæœºåˆ¶
```javascript
// é€šçŸ¥ç³»ç»Ÿ
class NotificationSystem {
    constructor() {
        this.defaultDuration = 3000;
        this.notifications = [];
    }
    
    show(message, type = 'success', duration = this.defaultDuration) {
        const notification = this.createNotification(message, type);
        document.body.appendChild(notification);
        
        this.animateIn(notification);
        
        setTimeout(() => {
            this.animateOut(notification);
        }, duration);
    }
    
    success(message, duration = this.defaultDuration) {
        this.show(message, 'success', duration);
    }
    
    error(message, duration = this.defaultDuration) {
        this.show(message, 'error', duration);
    }
    
    warning(message, duration = this.defaultDuration) {
        this.show(message, 'warning', duration);
    }
    
    info(message, duration = this.defaultDuration) {
        this.show(message, 'info', duration);
    }
}
```

## ğŸ”’ å®‰å…¨è€ƒè™‘

### å†…å®¹å®‰å…¨ç­–ç•¥
- **DOMPurify é›†æˆ**ï¼šæ¸…ç†ç”¨æˆ·è¾“å…¥å’Œè¾“å‡º
- **XSS é˜²æŠ¤**ï¼šé˜²æ­¢è·¨ç«™è„šæœ¬æ”»å‡»
- **æ•°æ®éªŒè¯**ï¼šéªŒè¯æ‰€æœ‰ç”¨æˆ·è¾“å…¥
- **å®‰å…¨å­˜å‚¨**ï¼šå®‰å…¨åœ°å­˜å‚¨ç”¨æˆ·è®¾ç½®

### æƒé™ç®¡ç†
```javascript
// æƒé™æ£€æŸ¥
function checkPermissions() {
    const requiredGrants = [
        'GM_setClipboard',
        'GM_addStyle',
        'GM_setValue',
        'GM_getValue'
    ];
    
    const missingGrants = requiredGrants.filter(grant => 
        typeof window[grant] === 'undefined'
    );
    
    if (missingGrants.length > 0) {
        console.error('Missing required grants:', missingGrants);
        return false;
    }
    
    return true;
}
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### æµ‹è¯•æ¶æ„
- **æ¨¡å—åŒ–æµ‹è¯•è®¾è®¡**ï¼šé¿å…é‡å¤ç”Ÿæˆå¤§é‡å ä½ç¬¦
- **ç®€åŒ–è®¾è®¡**ï¼šä½¿ç”¨ `SimpleTestSuite` æ›¿ä»£å¤æ‚çš„æ¨¡å—ç³»ç»Ÿ
- **Tampermonkeyé€‚é…**ï¼šæ¨¡æ‹Ÿæµè§ˆå™¨ç¯å¢ƒå’ŒCDNä¾èµ–
- **é…ç½®é©±åŠ¨**ï¼šé€šè¿‡é…ç½®æ–‡ä»¶ç»Ÿä¸€ç®¡ç†æµ‹è¯•è¡Œä¸º

### æµ‹è¯•åˆ†ç±»
- **åŸºç¡€æµ‹è¯•**ï¼šæ ¸å¿ƒåŠŸèƒ½éªŒè¯
- **è¾¹ç•Œæµ‹è¯•**ï¼šè¾¹ç¼˜æƒ…å†µå’Œé”™è¯¯å¤„ç†
- **é”™è¯¯æµ‹è¯•**ï¼šæ ¼å¼é”™è¯¯å’Œå¼‚å¸¸æƒ…å†µ
- **æ€§èƒ½æµ‹è¯•**ï¼šè½¬æ¢é€Ÿåº¦å’Œèµ„æºä½¿ç”¨

### æµ‹è¯•ç”¨ä¾‹è®¾è®¡
```javascript
// åŸºç¡€æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹
const BASE_TEST_DATA = {
    simpleHeader: {
        markdown: `# æ ‡é¢˜\n\nè¿™æ˜¯å†…å®¹`,
        description: 'åŸºç¡€æ ‡é¢˜ç»“æ„'
    },
    parallelText: {
        markdown: `# ä¸»æ ‡é¢˜\n\nç¬¬ä¸€è¡Œæ­£æ–‡\nç¬¬äºŒè¡Œæ­£æ–‡`,
        description: 'åŒçº§æ–‡æœ¬èŠ‚ç‚¹'
    },
    codeBlockWithSpecialChars: {
        markdown: `# ä»£ç å—\n\n\`\`\`javascript\nArtist('s )Name\n\`\`\``,
        description: 'ä»£ç å—ç‰¹æ®Šå­—ç¬¦å¤„ç†'
    }
};

// è¾¹ç•Œæµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹
const EDGE_CASES = {
    emptyContent: {
        markdown: '',
        description: 'ç©ºè¡Œå¤„ç†'
    },
    specialCharacters: {
        markdown: `# ç‰¹æ®Šå­—ç¬¦\n\n<>&"'`,
        description: 'HTMLç‰¹æ®Šå­—ç¬¦è½¬ä¹‰'
    },
    nestedStructure: {
        markdown: `# æ ‡é¢˜1\n## æ ‡é¢˜2\n### æ ‡é¢˜3\n#### æ ‡é¢˜4`,
        description: 'æ·±å±‚åµŒå¥—ç»“æ„'
    }
};
```

### éªŒè¯æ–¹æ³•
```javascript
// åŒå‘è½¬æ¢éªŒè¯ç¤ºä¾‹
function validateBidirectionalConversion(original, mdToQQ, qqToMD) {
    const errors = [];
    const warnings = [];
    
    // åŸºç¡€éªŒè¯
    if (!mdToQQ || !mdToQQ.title) {
        errors.push('MDâ†’QQ è½¬æ¢ç»“æœæ— æ•ˆ');
    }
    
    if (!qqToMD || typeof qqToMD !== 'string') {
        errors.push('QQâ†’MD è½¬æ¢ç»“æœæ— æ•ˆ');
    }
    
    // å†…å®¹å®Œæ•´æ€§éªŒè¯
    if (original.includes('æ­£æ–‡') && !qqToMD.includes('æ­£æ–‡')) {
        warnings.push('å¯èƒ½ä¸¢å¤±äº†éƒ¨åˆ†å†…å®¹');
    }
    
    // ç»“æ„éªŒè¯
    if (original.includes('```') && !qqToMD.includes('```')) {
        warnings.push('ä»£ç å—å¯èƒ½æœªæ­£ç¡®å¤„ç†');
    }
    
    return { passed: errors.length === 0, errors, warnings };
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### èµ„æºåŠ è½½ä¼˜åŒ–
- **å¼‚æ­¥åŠ è½½**ï¼šå¼‚æ­¥åŠ è½½éå…³é”®èµ„æº
- **ç¼“å­˜ç­–ç•¥**ï¼šå®ç°é€‚å½“çš„ç¼“å­˜æœºåˆ¶
- **ä»£ç åˆ†å‰²**ï¼šæŒ‰éœ€åŠ è½½åŠŸèƒ½æ¨¡å—
- **å†…å­˜ç®¡ç†**ï¼šåŠæ—¶æ¸…ç†ä¸éœ€è¦çš„èµ„æº

### é”™è¯¯å¤„ç†
```javascript
// å…¨å±€é”™è¯¯å¤„ç†
window.addEventListener('error', (event) => {
    console.error('Global error:', event.error);
    
    // å‘é€é”™è¯¯æŠ¥å‘Š
    if (window.QQMindMap2Obsidian && window.QQMindMap2Obsidian.notifications) {
        window.QQMindMap2Obsidian.notifications.error(
            'å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯'
        );
    }
});

// æœªå¤„ç†çš„ Promise æ‹’ç»
window.addEventListener('unhandledrejection', (event) => {
    console.error('Unhandled promise rejection:', event.reason);
});
```

## ğŸ“š æœ€ä½³å®è·µ

### å¼€å‘æµç¨‹
1. **æœ¬åœ°æµ‹è¯•**ï¼šåœ¨æœ¬åœ°ç¯å¢ƒæµ‹è¯•åŠŸèƒ½
2. **æµè§ˆå™¨æµ‹è¯•**ï¼šåœ¨ç›®æ ‡æµè§ˆå™¨ä¸­æµ‹è¯•
3. **ç”¨æˆ·åé¦ˆ**ï¼šæ”¶é›†ç”¨æˆ·åé¦ˆå¹¶è¿­ä»£
4. **ç‰ˆæœ¬ç®¡ç†**ï¼šä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶

### è°ƒè¯•æŠ€å·§
- **æ§åˆ¶å°æ—¥å¿—**ï¼šä½¿ç”¨æœ‰æ„ä¹‰çš„æ—¥å¿—æ¶ˆæ¯
- **é”™è¯¯è¾¹ç•Œ**ï¼šå®ç°é”™è¯¯è¾¹ç•Œå¤„ç†
- **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§è„šæœ¬æ€§èƒ½
- **ç”¨æˆ·åé¦ˆ**ï¼šæä¾›ç”¨æˆ·åé¦ˆæ¸ é“

### æµ‹è¯•ç»´æŠ¤
1. **å®šæœŸæ›´æ–°**ï¼šå®šæœŸæ›´æ–°æµ‹è¯•æ•°æ®
2. **åŠæ—¶ä¿®å¤**ï¼šåŠæ—¶ä¿®å¤å¤±è´¥çš„æµ‹è¯•
3. **å¯è¯»æ€§**ï¼šä¿æŒæµ‹è¯•ä»£ç çš„å¯è¯»æ€§
4. **å˜æ›´è®°å½•**ï¼šè®°å½•é‡è¦çš„æµ‹è¯•å˜æ›´
description:
globs:
alwaysApply: false
---
