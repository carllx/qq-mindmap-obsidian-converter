// ==UserScript==
// @name         QQ Mind Map to Obsidian Converter (Simple)
// @namespace    http://tampermonkey.net/
// @version      2.0.0
// @description  Converts QQ Mind Map to Obsidian Markdown and vice-versa
// @author       carllx & Gemini
// @match        https://docs.qq.com/mind/*
// @grant        GM_setClipboard
// @grant        GM_addStyle
// @grant        GM_setValue
// @grant        GM_getValue
// @require      https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js
// @require      https://cdn.jsdelivr.net/npm/dompurify@3.1.5/dist/purify.min.js
// ==/UserScript==

(function() {
    'use strict';

    console.log('üöÄ QQ Mind Map Converter (Simple) starting...');

    // Á´ãÂç≥ÂàõÂª∫ÂÖ®Â±ÄÂØπË±°
    window.QQMindMap2Obsidian = {
        test: true,
        version: 'simple',
        status: 'initializing'
    };
    console.log('‚úÖ Initial global object created:', window.QQMindMap2Obsidian);

    // ÁÆÄÂåñÁöÑÊ®°ÂùóÁ≥ªÁªü
    const modules = {};
    function define(name, factory) { 
        try {
            modules[name] = factory();
            console.log('‚úÖ Module loaded:', name);
        } catch (error) {
            console.error('‚ùå Error loading module:', name, error);
        }
    }
    function require(name) { 
        const module = modules[name];
        if (!module) {
            console.error('‚ùå Module not found:', name);
        }
        return module;
    }

{{MODULES}}

    // ÁÆÄÂåñÁöÑUIÁÆ°ÁêÜÂô®
    class SimpleInterfaceManager {
        constructor(converter) {
            this.converter = converter;
            this.container = null;
        }

        init() {
            console.log('üîß Initializing UI...');
            this.waitForUIAndInject();
        }

        waitForUIAndInject() {
            console.log('üîç Looking for target element...');
            const interval = setInterval(() => {
                // Â∞ùËØïÂ§ö‰∏™ÂèØËÉΩÁöÑÈÄâÊã©Âô®
                const selectors = [
                    '#editor-root > div > div > div.Footer_footer__DdscW',
                    '.Footer_footer__DdscW',
                    'footer',
                    'body'
                ];
                
                let targetElement = null;
                for (const selector of selectors) {
                    targetElement = document.querySelector(selector);
                    if (targetElement) {
                        console.log('‚úÖ Found target element with selector:', selector);
                        break;
                    }
                }
                
                if (targetElement) {
                    clearInterval(interval);
                    this.createUI(targetElement);
                    console.log('‚úÖ UI created successfully');
                } else {
                    console.log('‚è≥ Target element not found, retrying...');
                }
            }, 1000);
        }

        createUI(parentElement) {
            // ÂàõÂª∫ÂÆπÂô®
            this.container = document.createElement('div');
            this.container.id = 'converter-container';
            this.container.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 10000;
                display: flex;
                gap: 10px;
                background: rgba(255, 255, 255, 0.95);
                padding: 10px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                border: 1px solid #e0e0e0;
            `;

            // ÂàõÂª∫ÊåâÈíÆ
            const qqToMdBtn = document.createElement('button');
            qqToMdBtn.textContent = 'QQ to MD';
            qqToMdBtn.style.cssText = `
                background: #4CAF50;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
            `;
            qqToMdBtn.onclick = () => {
                console.log('üîò QQ to MD button clicked');
                this.converter.convertQQToMD();
            };

            const mdToQqBtn = document.createElement('button');
            mdToQqBtn.textContent = 'MD to QQ';
            mdToQqBtn.style.cssText = `
                background: #2196F3;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
            `;
            mdToQqBtn.onclick = () => {
                console.log('üîò MD to QQ button clicked');
                this.converter.convertMDToQQ();
            };

            // Ê∑ªÂä†ÊåâÈíÆÂà∞ÂÆπÂô®
            this.container.appendChild(qqToMdBtn);
            this.container.appendChild(mdToQqBtn);

            // Ê∑ªÂä†Âà∞È°µÈù¢
            parentElement.appendChild(this.container);
            console.log('‚úÖ UI elements added to page');
        }

        setLoadingState(isLoading) {
            console.log('üîÑ Loading state:', isLoading);
        }
    }

    // ÁÆÄÂåñÁöÑ‰∏ªËΩ¨Êç¢Âô®Á±ª
    class MainConverter {
        constructor() {
            console.log('üîß MainConverter constructor called');
            this.setupMarkdownIt();
            this.initializeComponents();
        }

        setupMarkdownIt() {
            console.log('üîß Setting up markdown-it...');
            if (typeof window.markdownit === 'undefined') {
                console.error('‚ùå markdown-it not available');
                return;
            }
            this.md = window.markdownit({
                html: false,
                linkify: true,
            }).enable('strikethrough');
            console.log('‚úÖ markdown-it setup complete');
        }

        initializeComponents() {
            console.log('üîß Initializing components...');
            try {
                // ‰ΩøÁî® require Ëé∑ÂèñÊ®°Âùó
                const NotificationSystem = require('NotificationSystem');
                const QQMindMapParser = require('QQMindMapParser');
                const QQToMarkdownConverter = require('QQToMarkdownConverter');
                const MarkdownToQQConverter = require('MarkdownToQQConverter');

                this.notifications = new NotificationSystem();
                this.notifications.addStyles();
                this.qqParser = new QQMindMapParser();
                this.qqToMdConverter = new QQToMarkdownConverter();
                this.mdToQqConverter = new MarkdownToQQConverter(this.md);
                this.interfaceManager = new SimpleInterfaceManager(this);
                this.interfaceManager.init();
                console.log('‚úÖ All components initialized');
            } catch (error) {
                console.error('‚ùå Error initializing components:', error);
            }
        }

        async convertQQToMD() {
            console.log('üîÑ QQ to MD conversion started');
            try {
                this.interfaceManager.setLoadingState(true);
                this.notifications.show('QQ to MD conversion started', 'info');

                const clipboardItems = await navigator.clipboard.read();
                for (const item of clipboardItems) {
                    if (item.types.includes('text/html')) {
                        const blob = await item.getType('text/html');
                        const html = await blob.text();
                        const mindMapData = this.qqParser.extractMindMapData(html);
                        const markdown = this.qqToMdConverter.convert(mindMapData);
                        GM_setClipboard(markdown);
                        this.notifications.success('QQ to MD conversion completed!');
                        return;
                    }
                }
                this.notifications.error('No QQ mind map data found in clipboard');
            } catch (err) {
                console.error('‚ùå QQ to MD conversion failed:', err);
                this.notifications.error('Conversion failed: ' + err.message);
            } finally {
                this.interfaceManager.setLoadingState(false);
            }
        }

        async convertMDToQQ() {
            console.log('üîÑ MD to QQ conversion started');
            try {
                this.interfaceManager.setLoadingState(true);
                this.notifications.show('MD to QQ conversion started', 'info');

                const markdown = await navigator.clipboard.readText();
                if (!markdown) {
                    this.notifications.error('Clipboard is empty or contains no text');
                    return;
                }

                const mindMapData = this.mdToQqConverter.convert(markdown);
                // Ê£ÄÊü• DOMPurify ÊòØÂê¶ÂèØÁî®
                if (typeof window.DOMPurify === 'undefined') {
                    console.error('‚ùå DOMPurify not available');
                    this.notifications.error('DOMPurify library not loaded');
                    return;
                }
                const html = window.DOMPurify.sanitize('<div data-mind-map=\'' + JSON.stringify(mindMapData) + '\'></div>');
                const plainText = this.qqParser.generatePlainText(mindMapData);
                
                const htmlBlob = new Blob([html], { type: 'text/html' });
                const textBlob = new Blob([plainText], { type: 'text/plain' });
                
                await navigator.clipboard.write([
                    new ClipboardItem({ 
                        'text/html': htmlBlob, 
                        'text/plain': textBlob 
                    })
                ]);
                
                this.notifications.success('MD to QQ conversion completed!');
            } catch (err) {
                console.error('‚ùå MD to QQ conversion failed:', err);
                this.notifications.error('Conversion failed: ' + err.message);
            } finally {
                this.interfaceManager.setLoadingState(false);
            }
        }
    }

    // ‰∏ªÂáΩÊï∞
    async function main() {
        try {
            console.log('üöÄ Main function starting...');
            
            // Á≠âÂæÖÈ°µÈù¢Âä†ËΩΩ
            if (document.readyState === 'complete') {
                console.log('‚úÖ Page already loaded');
            } else {
                console.log('‚è≥ Waiting for page to load...');
                await new Promise((resolve) => {
                    window.addEventListener('load', resolve);
                });
                console.log('‚úÖ Page loaded');
            }
            
            // Á≠âÂæÖ3ÁßíÁ°Æ‰øùÈ°µÈù¢ÂÆåÂÖ®ÂàùÂßãÂåñ
            console.log('‚è≥ Waiting 3 seconds for page initialization...');
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            console.log('üîß Creating MainConverter instance...');
            const converter = new MainConverter();

            // ÂàõÂª∫ÂÖ®Â±ÄÂØπË±°
            const globalObject = {
                converter,
                QQMindMapParser: require('QQMindMapParser'),
                QQToMarkdownConverter: require('QQToMarkdownConverter'),
                MarkdownToQQConverter: require('MarkdownToQQConverter'),
                NotificationSystem: require('NotificationSystem'),
                status: 'ready'
            };

            // Áõ¥Êé•ËµãÂÄºÂà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
            window.QQMindMap2Obsidian = globalObject;
            
            console.log('‚úÖ Global object created:', window.QQMindMap2Obsidian);
            
            // È™åËØÅÂØπË±°ÊòØÂê¶ÁúüÁöÑÂú®ÂÖ®Â±Ä‰ΩúÁî®Âüü‰∏≠
            setTimeout(() => {
                console.log('üîç Verification - Global object check:', window.QQMindMap2Obsidian);
                if (window.QQMindMap2Obsidian) {
                    console.log('‚úÖ Global object is accessible!');
                } else {
                    console.log('‚ùå Global object is not accessible!');
                }
            }, 1000);
            
        } catch (error) {
            console.error('‚ùå Error in main function:', error);
        }
    }

    // ÂêØÂä®‰∏ªÂáΩÊï∞
    main();

})(); 